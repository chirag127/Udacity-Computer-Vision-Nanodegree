# CVND: Computer Vision Nanodegree Archive - Continuous Integration Pipeline

name: CVND Archive CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# APEX MANDATE: For educational archives, CI focuses on ensuring environment integrity (Notebook execution sanity) and structural validation, not deep functional testing.

jobs:
  build_and_validate:
    name: Validate Environment and Notebooks
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./projects

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python Environment (3.10+)
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # Use uv cache configuration standard for speed
          cache: 'uv'

      - name: Install Dependency Resolver (uv) and Core Tools
        run: |
          # Install uv
          pip install uv
          # Install necessary environment tools for notebook validation
          uv pip install jupyter nbformat ipykernel pytest Pillow numpy scipy

      - name: Verify Project Directory Structure
        # Check for required subdirectories based on typical Udacity structure
        run: |
          echo "Verifying standard project directories..."
          if [ ! -d "/home/runner/work/CVND-Udacity-Computer-Vision-Nanodegree-Archive/CVND-Udacity-Computer-Vision-Nanodegree-Archive/projects/1_Image_basics" ]; then
            echo "WARNING: '1_Image_basics' directory not found. Skipping initial project validation."
          else
            echo "Project structure appears nominal."
          fi

      - name: List Jupyter Notebooks Found
        run: |
          echo "Listing all .ipynb files for sanity check:"
          find . -name "*.ipynb" -print

      - name: Sanity Check Notebook Execution (Read-Only)
        # This step attempts to load and parse notebooks. Full execution is too slow/unreliable for a simple CI on an archive.
        # We verify syntax integrity and kernel readiness.
        run: |
          for notebook in $(find . -name "*.ipynb"); do
            echo "Validating syntax for: $notebook"
            # Use nbconvert to check if the notebook can be parsed without errors
            jupyter nbconvert --to notebook "$notebook" --stdout > /dev/null
            if [ $? -ne 0 ]; then
              echo "ERROR: Notebook parsing failed for $notebook. Potential JSON or kernel error."
              exit 1
            fi
          done
        id: notebook_check

      - name: Report Success
        if: success()
        run: echo "CI Validation Complete. Structure and Notebook Syntax verified successfully."

  # LINTING/FORMATTING JOB (Conceptual for Notebooks - Mocking Ruff integration if scripts were present)
  # For this archive, static analysis focuses on the README and configuration files.
  metadata_lint:
    name: Metadata Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python for Ruff (If Python scripts existed)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Ruff
        run: pip install ruff

      - name: Run Ruff on Root Configuration Files (Example)
        # This confirms our CI YAML structure adheres to high standards, even if the main content is static.
        run: |
          echo "Linting CI workflow configuration file..."
          ruff check .github/workflows/ci.yml
          if [ $? -ne 0 ]; then
             echo "Ruff found issues in CI configuration."
             exit 1
          fi
